src_unpack() {
    git clone https://github.com/stenzek/duckstation.git .
}

src_prepare() {
    git checkout "$PKG_REF"

    fs::mkdir build
}

src_build() {
    cd build

    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_NOGUI_FRONTEND=OFF -DBUILD_QT_FRONTEND=ON -DUSE_DRMKMS=OFF -DUSE_EGL=ON -DUSE_SDL2=ON -DUSE_WAYLAND=ON -DUSE_X11=ON -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON -DCMAKE_PREFIX_PATH=$HOME/deps -DCMAKE_TOOLCHAIN_FILE=../scripts/clang-toolchain.cmake ..
    cmake --build . --parallel
}

src_install() {
    local base_dir="${XDG_CONFIG_HOME:-${HOME}/.config}/retroarch"
    fs::mkdir "${base_dir}/cores" "${base_dir}/system/pcsx2/"{bios,cheats,cheats_ws,memcards}

    install build/pcsx2/pcsx2_libretro.so "${base_dir}/cores"
}
